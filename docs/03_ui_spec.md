# 画面仕様書 v1.0（React + Vite）

最終更新: 2025-10-12 / 対象: 基本設計 v1.0 準拠

---

## 0. 方針

* 画面は **ログイン → ダッシュボード → 編集 → 結果/ワークスペース** の単純フロー。
* サムネイルは **逐次生成**。結果は自動ダウンロードしない。ワークスペースで **続けて処理** が可能。
* 状態管理は Zustand を想定。
* レイアウト/カラーパレット等の詳細は `docs/design.html`（デザイン案）を参照する。

---

## 1. 画面一覧

| ID   | 画面名        | 目的                 |
| ---- | ---------- | ------------------ |
| S-01 | ログイン       | 認証、CSRFトークン取得      |
| S-02 | ダッシュボード    | 操作の入口（結合/分割/順序/圧縮） |
| S-03 | 編集（結合）     | 複数PDFの並び替えと実行      |
| S-04 | 編集（順序）     | 単一PDFのページ順入替       |
| S-05 | 編集（分割）     | 範囲指定で分割            |
| S-06 | 編集（圧縮）     | プリセット選択で圧縮         |
| S-07 | 結果/ワークスペース | 出力の保持、DL、続けて処理     |

---

## 2. 主要コンポーネント構成

```
<App>
  <AuthGate>
    <Router>
      <LoginPage(S-01)>
        <LoginForm>
      <DashboardPage(S-02)>
        <ActionTileList>
      <EditMergePage(S-03)>
        <UploadPanel>  // 小: form直送 / 大: 署名URL→GCS直PUT
        <FileListDnD>
        <ProgressBar>
        <RunButtons>
      <EditReorderPage(S-04)>
        <UploadPanel>
        <ThumbnailGridVirtualized>
        <PageDnD>
        <ProgressBar>
        <RunButtons>
      <EditSplitPage(S-05)>
        <UploadPanel>
        <RangesInput>
        <ProgressBar>
        <RunButtons>
      <EditOptimizePage(S-06)>
        <UploadPanel or WorkspacePicker>
        <PresetSelector>
        <ProgressBar>
        <RunButtons>
      <WorkspacePage(S-07)>
        <ResultPreview>
        <MetaPanel>
        <DownloadButton>
        <ContinueActions>
```

---

## 3. 画面詳細仕様

### S-01 ログイン

* 入力: username, password
* ボタン: [ログイン]
* 成功: 204／Set-Cookie, 応答ヘッダから CSRF を保存
* 失敗: `401` → エラー表示、5回失敗で残り時間を表示

### S-02 ダッシュボード

* タイル: 結合 / 分割 / 順序 / 圧縮
* ワークスペースに結果があれば「最近の結果」カードを表示

### S-03 編集（結合）

* アップロード: 複数選択可。サイズ/拡張子/署名をクライアントで事前チェック
* 並び替え: FileListDnD（ドラッグで順序変更）
* 実行: [結合を実行]
* 進捗: 0–100%（読込/処理/書込）
* 完了: ワークスペースに `merged.pdf` を保存し、S-07へ遷移案内

### S-04 編集（順序）

* アップロード: 単一PDF
* 入力フォーム: 1 始まりのページ番号をカンマ区切りで指定（例: `3,1,2,4`）
* 送信時に 0-based 配列へ変換し API へ送信
* 実行: [ページ順を入替える]
* 完了: ワークスペースに `reordered.pdf` を保存

### S-05 編集（分割）

* 入力: 範囲文字列（例: `1-3,7,10-`）
* バリデーション: 後述ルールに従い即時エラー表示
* 実行: [分割を実行] → 結果は zip

### S-06 編集（圧縮）

* 入力: プリセット `standard` / `aggressive`
* 対象: 単一PDF（※ワークスペースからの直接指定は今後拡張）
* 実行: [PDFを圧縮する]

### S-07 結果/ワークスペース

* 表示: ファイル名/種別/サイズ/ハッシュ先頭8桁
* プレビュー: 代表ページ（1枚）
* 操作: [ダウンロード] / [続けて…]（圧縮/分割/順序）

---

## 4. 入力バリデーション仕様（抜粋）

| 項目          | ルール                            | エラー表示例                  |
| ----------- | ------------------------------ | ----------------------- |
| ファイルサイズ     | 1ファイル ≤ 100MB                  | 「100MBを超えています」          |
| 総サイズ        | 合計 ≤ 300MB                     | 「合計サイズ上限(300MB)を超えています」 |
| ページ数        | 1ファイル ≤ 200頁                   | 「200頁を超えています」           |
| 拡張子/MIME/署名 | 3点一致                           | 「PDFではありません」            |
| 範囲文字列       | `^\d+(-\d+)?(,\d+(-\d+)?)*-?$` | 「範囲の形式が正しくありません」        |
| ページ順序       | 欠落/重複なし（UIは1..N表示、API送信時は0..N-1へ変換） | 「ページの重複/欠落があります」        |

---

## 5. 進捗表示

* バー: 0–100%、`load 20% / process 60% / write 20%` の比率
* 長時間: 自動で非同期ジョブに切替 → ジョブIDを保持し2秒間隔でポーリング
* ステージ表示: `queued / load / process / write / completed` を日本語ラベルに変換してモーダルに表示
* 中断: キャンセル操作は v1.0 では未対応（v1.1候補）

---

## 6. ワークスペース（チェーン実行）

* `lastResult` を保持し、次の処理の **入力として再利用**
* 実行後は履歴 `history` に積む（戻る/やり直しは v1.1候補）
* 自動ダウンロードは行わない

---

## 7. エラーハンドリング（UI）

* 入力エラー: 項目下に赤字。トーストは重要エラーのみ
* サーバーエラー: トースト + 詳細ダイアログ（`code`, `message`）
* 上限超過: 明示メッセージ + 代替（GCS直PUTの案内）

| API `code`          | 画面メッセージ                             |
| ------------------- | ---------------------------------------- |
| `INVALID_INPUT`     | 「入力が正しくありません。内容を確認してください。」          |
| `LIMIT_EXCEEDED`    | 「上限を超えています。ファイルサイズやページ数を調整してください。」 |
| `UNSUPPORTED_PDF`   | 「PDFを処理できませんでした。ファイルを確認してください。」     |
| `TOO_MANY_ATTEMPTS` | 「試行が多すぎます。しばらく待ってから再度お試しください。」       |
| `INTERNAL`          | 「サーバーで問題が発生しました。時間を置いて再実行してください。」   |
| `UNAUTHORIZED`      | 「ログインが必要です。ページを再読み込みして再ログインしてください。」 |
| `FORBIDDEN`         | 「もう一度ログインしてから操作をやり直してください。」              |

---

## 8. アクセシビリティ/その他

* キーボード操作: DnD不可環境向けに「↑/↓で並び替え」補助
* スクリーンリーダー: ボタンに `aria-label`
* i18n: 日本語固定（将来拡張）
* レスポンシブ: 最小幅 360px を想定

---

## 9. 主要UIテキスト（例）

* 成功: 「処理が完了しました」
* 失敗: 「処理に失敗しました（{code}）」
* ロックアウト: 「試行が多すぎます。{minutes}分後にお試しください」

---

## 10. ルーティング（案）

* `/login` → S-01
* `/` → S-02
* `/edit/merge` → S-03
* `/edit/reorder` → S-04
* `/edit/split` → S-05
* `/edit/optimize` → S-06
* `/workspace` → S-07
